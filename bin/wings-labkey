#!/data/workspace/disk/.venv/bin/python

#  Copyright 2007-2015 University Of Southern California
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing,
#  software distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

__author__ = 'Rajiv Mayani <mayani@isi.edu>'

import sys
import logging
import argparse
import StringIO
import ConfigParser
from functools import wraps

import os
from disk.labkey import Labkey
from disk.errors import AuthenticationException, LabkeyException


def configure_logging(verbosity=0):
    verbosity = min(3, verbosity)

    log_levels = [
        logging.ERROR,
        logging.WARN,
        logging.INFO,
        logging.DEBUG
    ]

    logging.basicConfig(level=log_levels[verbosity],
                        format='%(asctime)s:%(levelname)s:%(name)s(%(lineno)d): %(message)s')


def upload_file(project, file_name, destination, base_url=None, username=None, password=None, create=False,
                overwrite=False, config=None, **kwargs):
    if not os.path.isfile(file_name):
        logging.error('File %r either does not exist or is not readable' % file_name)
        sys.exit(1)

    file_name = os.path.abspath(file_name)
    files = {
        'file': (os.path.basename(file_name), open(file_name, 'rb').read())
    }

    destination = os.path.join(project, destination)

    client = Labkey(base_url=base_url, username=username, password=password, project=project, config=config)

    try:
        client.upload_file(destination, files, create=create, overwrite=overwrite)
        print 'File uploaded successfully'

    except AuthenticationException as e:
        logging.error(e)

    except LabkeyException as e:
        logging.error(e)

    finally:
        del client


def select_rows(schema, query, base_url=None, username=None, password=None, project=None, config=None, **kwargs):
    client = Labkey(base_url=base_url, username=username, password=password, project=project, config=config)

    try:
        print client.select_rows(schema, query)

    except AuthenticationException as e:
        logging.error(e)

    except LabkeyException as e:
        logging.error(e)

    finally:
        del client


def execute_sql(schema, sql, base_url=None, username=None, password=None, project=None, config=None, **kwargs):
    client = Labkey(base_url=base_url, username=username, password=password, project=project, config=config)

    try:
        print client.execute_sql(schema, sql)

    except AuthenticationException as e:
        logging.error(e)

    except LabkeyException as e:
        logging.error(e)

    finally:
        del client


def main():
    parser = argparse.ArgumentParser(description='Wings Labkey Integration')
    sub_parser = parser.add_subparsers(title='File Upload', description='Upload file to labkey server')

    # File Upload Options
    upload = sub_parser.add_parser('upload')
    upload.add_argument('-f', '--file', dest='file_name', required=True)
    upload.add_argument('-d', '--destination', dest='destination', required=True,
                        help='Destination directory where the file should be uploaded')
    upload.add_argument('-c', '--create', default=False, action='store_true',
                        help='Create destination directory if it does not exists')
    upload.add_argument('-o', '--overwrite', default=False, action='store_true', help='Overwrite the file if it exists')
    upload.set_defaults(func=upload_file)

    select = sub_parser.add_parser('select')
    select.add_argument('-s', '--schema', required=True)
    select.add_argument('-q', '--query', required=True)
    select.set_defaults(func=select_rows)

    sql = sub_parser.add_parser('sql')
    sql.add_argument('-s', '--schema', required=True)
    sql.add_argument('-q', '--sql', required=True)
    sql.set_defaults(func=execute_sql)

    parser.add_argument('-b', '--base-url')
    parser.add_argument('-u', '--username')
    parser.add_argument('-p', '--password')
    parser.add_argument('-n', '--project')
    parser.add_argument('-c', '--config')
    parser.add_argument('-v', '--verbose', default=0, action='count', help='Logging verbosity')

    args = parser.parse_args(sys.argv[1:])

    configure_logging(args.verbose)

    args.func(**vars(args))


if __name__ == '__main__':
    main()
